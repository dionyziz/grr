#!/bin/bash
cd ..
echo 'Running tests...'

# Have to remain disabled for now:
# Failing for unknown reasons: AccessControlTest,StatsStoreDataQueryTest
# Failing for OOM reasons: SqliteDataStoreTest

EXCLUDE_TESTS=AccessControlTest,StatsStoreDataQueryTest,SqliteDataStoreTest,TestTransfer,FlowLimitTests,TestFileFinderFlow,ListVADBinariesTest,ApiRenderersTest,RDFDatetimeSecondsTest,GrrWorkerTest,VFSGRRClientApiObjectRendererTest,DeleteGRRTempFiles,GlobExpressionTest,CheckAccessHelperTest,ArtifactTest,BasicFlowTest,CSVOutputPluginTest,TestMemoryAnalysis,PathSpecTest,IndexTest,TestApplyLabelsToClientsFlow,TestMemoryCollector,OSXFilesystemTests,ChecksTestBase,HashFileStoreExportPluginTest,TestWebHistoryWithArtifacts,ApiHuntsListRendererTest,QueueManagerTest,TestFingerprintFlow,TypeInfoTest,PlistTest,OSSpecificClientTests,FlowCreationTest,GRRFuseTestBase,NetworkAddressTests,RDFStringTest,HTTPClientTests,MemoryTest,LinuxFileParserTest,GRRFEServerTest,TestDebugFlows,TestNetworkByteLimits,OSXVersionTests,ProbeTest,AFF4ObjectTest,TestFindFlow,HTTPDataStoreCSVBenchmarks,SQLiteFileTest,ApiAff4IndexRendererTest,CheckResultsTest,AFF4IndexSetTest,HTTPDataStoreBenchmarks,ArtifactTests,TestRegistryFlows,StatsStoreTest,MicroBenchmarks,TestWebHistory,BlobImageTest,TestInterpolatePath,GRRUserTest,EntryPointTest,TestAuditSystem,LexerTests,ProfileServerTest,OSXClientTests,SignedBlobTest,AccessControlTest,BuildConfigTests,LinuxReleaseParserTest,CheckRegistryTests,StatsStoreDataQueryTest,FileStoreTest,AFF4ObjectApiObjectRendererTest,OSXLaunchdJobDictTest,ActionTest,VFSTest,Firefox3HistoryTest,CheckTest,GenericRDFProtoTest,CronTest,RDFDatetimeTest,FilehashTest,XoredSearchingTest,GRRFuseTest,ClientCommsTest,FilterTests,AFF4SparseImageTest,ByteSizeTest,OSXEnumerateRunningServicesTest,TimelineTest,TestTimelines,TestPackedVersionedCollection,VFSDirectoryTest,TDBDataStoreBenchmarks,FakeDataStoreBenchmarks,AverageMicroBenchmarks,TestListVolumeShadowCopies,WindowsPersistenceMechanismsParserTest,HashDigestTest,WMIParserTest,CollectionExportPluginTest,StatsTests,MasterTest,ApiAff4RendererTest,SendEmailTests,TestClientInterrogate,TestExportHuntResultsFilesAsArchive,RDFURNTest,LinuxSoftwareParserTest,ArtifactParserTest,TestFilesystem,HuntTest,BatchConverterTest,TestArtifactCollectorsInteractions,OSXQuarantineTest,CollectorTest,CollectionFilesExportPluginTest,StandardHuntTest,UserTests,TestSearchFileContentWithFixture,TestCollections,ArtifactParserTests,DarwinPersistenceMechanismsParserTest,RDFValueCollectionApiObjectRendererTest,WebHistoryFlowTest,HTTPDataStoreTest,DataAgnosticExportConverterTest,GRRSeleniumTest,SqliteDataStoreBenchmarks,TestSystemRootSystemDriveFallbackFlow,OutputpluginsTest,ConfigFileTest,FlowTest,RegistryFlowTest,ExportTest,MatchMethodTests,ResultSetTest,FakeDataStoreTest,HintDefinitionTests,TestAdministrativeFlows,GRRTempFileTestFilename,FilestoreStatsCronFlowTest,ForemanTests,ReportsTest,GRRBaseTest,TestEndToEndTestFlow,DictTest,TestArtifactCollectorsRealArtifacts,KnowledgeBaseUserMergeTest,HandlerTests,NetstatTest,BasicContextTests,ArtifactHandlingTest,ObjcTest,TestWindowsMemory,WindowsActionTests,GrepTest,SystemCronFlowTest,UtilsTest,DataStoreCSVBenchmarks,CheckLoaderTests,TDBDataStoreCSVBenchmarks,ArtifactKBTest,MultiShardedQueueManagerTest,ConfigActionTest,SearchTest,RegistryVFSTests,OSXDriverTests,RekallTestSuite,GeneralFlowsTest,FlowStateTest,TestCryptoTypeInfos,AFF4Benchmark,GRRArtifactTest,GRRFuseDatastoreOnlyTest,TestOSXFileParsing,AFF4SymlinkTest,FlowTestsBaseclass,ConditionTest,RekallVADParserTest
PYTHONPATH=. python grr/run_tests.py --processes=1 --exclude_tests=$EXCLUDE_TESTS 2>&1|grep -v 'DEBUG:'|grep -v 'INFO:'
TEST_STATUS=${PIPESTATUS[0]}
exit $TEST_STATUS
